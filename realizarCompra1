CREATE FUNCTION realizar_compra(
	cod_compra int,
  	nome_fornecedor VARCHAR(40),
	nome_produto VARCHAR(25),
    quantidade INT,
    preco_unitario FLOAT
) RETURNS VOID AS $$
DECLARE
    COD_FORN INT;
    COD_EMP INT;
    COD_PROD INT;
    COD_ESTOQUE INT;
BEGIN
    -- Obter o ID do fornecedor com base no nome
    SELECT id_fn INTO COD_FORN FROM Fornecedor WHERE nome_fn = nome_fornecedor;
    -- Obter o ID da empresa com base no current user
    SELECT id_emp INTO COD_EMP FROM Empresa WHERE nome_emp = current_user;
	SELECT ID_PROD INTO COD_PROD FROM PRODUTO WHERE NOME_PROD = NOME_PRODUTO;
	SELECT ID_ESTOQUE INTO COD_ESTOQUE FROM ESTOQUE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
	
	IF VERIFICAR_FORNECEDOR_EMPRESA(fornecedor_id, empresa_id) THEN
		IF PRODUTO_EXISTE(NOME_PRODUTO) THEN
			IF PRODUTO_EXISTE_NA_EMPRESA(COD_PROD, COD_EMP) THEN --SE PRODUTO JA EXISTE, A EMPRESA SO ESTÁ REPONDO
				IF COMPRA_EXISTE(COD_COMPRA, COD_EMP) THEN
					UPDATE COMPRA SET VALOR_TOTAL_COMPRA = VALOR_TOTAL_COMPRA + (QUANTIDADE*PRECO_UNITARIO)
						WHERE ID_COMPRA = COD_COMPRA;
					IF ITEM_COMPRA_EXISTE(COD_COMPRA, COD_ESTOQUE) THEN
						UPDATE ITEM_COMPRA SET QTD_COMPRA = QTD_COMPRADA + QUANTIDADE, 
							VALOR_TOTAL_ITEM_C = VALOR_TOTAL_ITEM_C+(QUANTIDADE*PRECO_UNITARIO)
							WHERE COMPRAID = COD_COMPRA AND ESTOQUEID = COD_ESTOQUE;
					ELSE
						INSERT INTO ITEM_COMPRA VALUES(COD_COMPRA, COD_ESTOQUE, QUANTIDADE, QUANTIDADE*PRECO_UNITARIO, PRECO_UNITARIO);
					END IF;
					UPDATE ESTOQUE SET QUANT_ESTQ = QUANTIDADE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
				ELSE 
					INSERT INTO COMPRA VALUES(COD_COMPRA, COD_FORN, CURRENT_TIMESTAMP, QUANTIDADE*PRECO_UNITARIO);
					INSERT INTO ITEM_COMPRA VALUES(COD_COMPRA, COD_ESTOQUE, QUANTIDADE, QUANTIDADE*PRECO_UNITARIO, PRECO_UNITARIO);
					UPDATE ESTOQUE SET QUANT_ESTQ = QUANTIDADE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
				END IF;
			ELSE --SE PRODUTO NÃO EXISTE NA EMPRESA
				SELECT ID_PROD INTO COD_PROD FROM PRODUTO WHERE NOME_PROD = NOME_PRODUTO;
				INSERT INTO ESTOQUE VALUES(COD_EMP, COD_PROD, PRECO_UNITARIO, QUANTIDADE);--CADASTRANDO PRODUTO NA EMPRESA

				IF COMPRA_EXISTE(COD_COMPRA, COD_EMP) THEN
					UPDATE COMPRA SET VALOR_TOTAL_COMPRA = VALOR_TOTAL_COMPRA + (QUANTIDADE*PRECO_UNITARIO)
						WHERE ID_COMPRA = COD_COMPRA;
					IF ITEM_COMPRA_EXISTE(COD_COMPRA, COD_ESTOQUE) THEN
						UPDATE ITEM_COMPRA SET QTD_COMPRA = QTD_COMPRADA + QUANTIDADE, 
							VALOR_TOTAL_ITEM_C = VALOR_TOTAL_ITEM_C+(QUANTIDADE*PRECO_UNITARIO)
							WHERE COMPRAID = COD_COMPRA AND ESTOQUEID = COD_ESTOQUE;
					ELSE
						INSERT INTO ITEM_COMPRA VALUES(COD_COMPRA, COD_ESTOQUE, QUANTIDADE, QUANTIDADE*PRECO_UNITARIO, PRECO_UNITARIO);
					END IF;
					UPDATE ESTOQUE SET QUANT_ESTQ = QUANTIDADE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
				ELSE 
					INSERT INTO COMPRA VALUES(COD_COMPRA, COD_FORN, CURRENT_TIMESTAMP, QUANTIDADE*VALOR_UNITARIO);
					INSERT INTO ITEM_COMPRA VALUES(COD_COMPRA, COD_ESTOQUE, QUANTIDADE, QUANTIDADE*PRECO_UNITARIO, PRECO_UNITARIO);
					UPDATE ESTOQUE SET QUANT_ESTQ = QUANTIDADE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
				END IF;
			END IF;
		ELSE --SE O PRODUTO NÃO EXISTE NA TABELA PRODUTO
			INSERT INTO PRODUTO VALUES(NOME_PRODUTO);
			SELECT ID_PROD INTO COD_PROD FROM PRODUTO WHERE NOME_PROD = NOME_PRODUTO;
			INSERT INTO ESTOQUE VALUES(COD_EMP, COD_PROD, VALOR_UNITARIO, QUANTIDADE);--CADASTRANDO PRODUTO NA EMPRESA

			IF COMPRA_EXISTE(COD_COMPRA, COD_EMP) THEN
				UPDATE COMPRA SET VALOR_TOTAL_COMPRA = VALOR_TOTAL_COMPRA + (QUANTIDADE*PRECO_UNITARIO)
					WHERE ID_COMPRA = COD_COMPRA;
				IF ITEM_COMPRA_EXISTE(COD_COMPRA, COD_ESTOQUE) THEN
					UPDATE ITEM_COMPRA SET QTD_COMPRA = QTD_COMPRADA + QUANTIDADE, 
						VALOR_TOTAL_ITEM_C = VALOR_TOTAL_ITEM_C+(QUANTIDADE*PRECO_UNITARIO)
						WHERE COMPRAID = COD_COMPRA AND ESTOQUEID = COD_ESTOQUE;
				ELSE
					INSERT INTO ITEM_COMPRA VALUES(COD_COMPRA, COD_ESTOQUE, QUANTIDADE, QUANTIDADE*PRECO_UNITARIO, PRECO_UNITARIO);
				END IF;
				UPDATE ESTOQUE SET QUANT_ESTQ = QUANTIDADE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
			ELSE 
				INSERT INTO COMPRA VALUES(COD_COMPRA, COD_FORN, CURRENT_TIMESTAMP, QUANTIDADE*PRECO_UNITARIO);
				INSERT INTO ITEM_COMPRA VALUES(COD_COMPRA, COD_ESTOQUE, QUANTIDADE, QUANTIDADE*PRECO_UNITARIO, PRECO_UNITARIO);
				UPDATE ESTOQUE SET QUANT_ESTQ = QUANTIDADE WHERE EMPID = COD_EMP AND PRODID = COD_PROD;
			END IF;
		END IF;
	END IF;
END;
$$ LANGUAGE plpgsql;

